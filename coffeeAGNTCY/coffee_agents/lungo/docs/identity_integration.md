# Agntcy Identity Integration

## Prerequisites

1. **Install ngrok CLI**  
   Download and install the ngrok CLI from [ngrok's official website](https://ngrok.com/download).

2. **Run the `start_ngrok.sh` Script**  
   This script creates a tunnel to your local machine on port 4444 and exposes it to the public internet. It also updates the `IDP_ISSUER_URL` in `docker-compose.yml` and the `issuer` field in `hydra.yml`.

   Run the script:
   ```bash
   # At lungo directory
   ./start_ngrok.sh
   ```

**Note**: If you need to re-run the script, kill the existing `ngrok` process first:
   ```bash
   pkill -f ngrok 
   ```

## Start All Services

To start all services using Docker Compose, run:
```bash
# At lungo directory
docker-compose up
```

## Local Development

For local development, follow these steps:

1. **Start Hydra Services**  
   After the `start_ngrok.sh` script updates the issuer URL, start the Hydra services:
   ```bash
   docker-compose up sqlite hydra hydra-migrate consent postgresd
   ```

2. **Run the Identity Node Services**  
   Open a new terminal, clone the Identity repository, and navigate to its root directory:
   ```bash
   git clone https://github.com/agntcy/identity
   cd identity
   ```
   Start the Identity service:
   ```bash
   ./deployments/scripts/identity/launch_node.sh
   ```

3. **Run the Exchange Server**  
   Start the Exchange server locally. Ensure the `REGISTER_ISSUER` environment variable is set to `true` if the `start_ngrok.sh` script was recently executed or the ngrok URL has changed:
   ```bash
   # At lungo directory
   REGISTER_ISSUER=true IDP_ISSUER_URL="https://<ngrok-url>" uv run python exchange/main.py
   ```
   If the ngrok URL has not changed, set `REGISTER_ISSUER` to `false`.

**Notes**
- Always set `REGISTER_ISSUER=true` after running the `start_ngrok.sh` script or when the ngrok URL changes.
- Replace `<ngrok-url>` with the public URL generated by ngrok.