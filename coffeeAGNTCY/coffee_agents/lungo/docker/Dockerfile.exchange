# `coffeeAGNTCY/coffee_agents/lungo/docker/Dockerfile.exchange`
FROM python:3.13.0-slim

ARG BUILD_VERSION=unknown
ARG BUILD_DATE=unknown
ARG BUILD_TIMESTAMP=unknown
ARG GIT_COMMIT=unknown
ARG GIT_COMMIT_SHORT=unknown
ARG GIT_BRANCH=unknown
ARG BUILD_NUMBER=unknown
ARG BUILD_WORKFLOW=unknown
ARG BUILD_ACTOR=unknown

# Install system dependencies, including curl, ping, and wget
RUN apt-get update && \
    apt-get install -y --no-install-recommends git curl wget iputils-ping && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install uv and create virtual environment
RUN pip install --no-cache-dir uv && \
    uv venv -q /venv
ENV PATH="/venv/bin:$PATH"
ENV ABOUT_RELEASE_TAG=$BUILD_VERSION

# Set PYTHONPATH to include the application directory
ENV PYTHONPATH="/app"

WORKDIR /app
COPY coffeeAGNTCY/coffee_agents/lungo/pyproject.toml coffeeAGNTCY/coffee_agents/lungo/uv.lock ./
RUN uv sync --locked --no-editable

COPY coffeeAGNTCY/coffee_agents/lungo/ .

## Generate about.properties file with build metadata
RUN printf "app.name=lungo-exchange\n"                > about.properties && \
    printf "app.service=lungo-exchange\n"            >> about.properties && \
    printf "version=%s\n"            "$BUILD_VERSION"    >> about.properties && \
    printf "date=%s\n"               "$BUILD_DATE"       >> about.properties && \
    printf "timestamp=%s\n"          "$BUILD_TIMESTAMP"  >> about.properties && \
    printf "git.commit=%s\n"         "$GIT_COMMIT"       >> about.properties && \
    printf "git.commit.short=%s\n"   "$GIT_COMMIT_SHORT" >> about.properties && \
    printf "git.branch=%s\n"         "$GIT_BRANCH"       >> about.properties && \
    printf "build.number=%s\n"       "$BUILD_NUMBER"     >> about.properties && \
    printf "build.workflow=%s\n"     "$BUILD_WORKFLOW"   >> about.properties && \
    printf "build.actor=%s\n"        "$BUILD_ACTOR"      >> about.properties && \
    printf "image.name=%s\n"         "ghcr.io/agntcy/coffee-agntcy/lungo-exchange" >> about.properties && \
    printf "image.tag=%s\n"          "$BUILD_VERSION"    >> about.properties

CMD ["uv", "run", "python", "agents/supervisors/auction/main.py"]